import argparse
import json
import os
import sqlite3
import sys
import zipfile
from pathlib import Path

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤–Ω—É—Ç—Ä–∏ ZIP-–∞—Ä—Ö–∏–≤–∞
# –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–¥ –±–æ–ª–µ–µ —á–∏—Ç–∞–µ–º—ã–º, —á–µ–º "–º–∞–≥–∏—á–µ—Å–∫–∏–µ" —Å—Ç—Ä–æ–∫–∏ –≤ –∫–æ–¥–µ
FILES_TO_SKIP = ('index.json',)
PREFIXES_TO_SKIP = ('tag_bank',)

def create_database(db_path: Path) -> sqlite3.Connection:
    """–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö SQLite –∏ —Ç–∞–±–ª–∏—Ü—É 'translations'."""
    print(f"–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤: {db_path}")
    try:
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ. –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç, –æ–Ω –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω.
        con = sqlite3.connect(db_path)
        cur = con.cursor()
        # –°—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü—ã –æ—Å—Ç–∞–ª–∞—Å—å –ø—Ä–µ–∂–Ω–µ–π
        cur.execute('''
            CREATE TABLE translations (
                word TEXT,
                reading TEXT,
                kind TEXT,
                english TEXT,
                priority INTEGER
            )
        ''')
        con.commit()
        return con
    except sqlite3.Error as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}", file=sys.stderr)
        sys.exit(1)

def import_dictionary_from_zip(zip_path: Path, con: sqlite3.Connection):
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–¥–Ω–æ–≥–æ ZIP-–∞—Ä—Ö–∏–≤–∞ —Å–ª–æ–≤–∞—Ä—è –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Ö –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
    –í—Å–µ –≤—Å—Ç–∞–≤–∫–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
    """
    print(f"–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –∏–º–ø–æ—Ä—Ç –∏–∑ –∞—Ä—Ö–∏–≤–∞: {zip_path.name}...")
    
    # –°–æ–∑–¥–∞–µ–º –∫—É—Ä—Å–æ—Ä –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–º–ø–æ—Ä—Ç–∞ –∏–∑ —Ñ–∞–π–ª–∞
    cur = con.cursor()
    total_entries_added = 0

    try:
        with zipfile.ZipFile(zip_path, 'r') as zip_f:
            for name in zip_f.namelist():
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –ø—Ä–µ—Ñ–∏–∫—Å—É
                if name in FILES_TO_SKIP or name.startswith(PREFIXES_TO_SKIP):
                    continue

                # –ò—Å–ø–æ–ª—å–∑—É–µ–º 'with' –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è —Ñ–∞–π–ª–∞
                with zip_f.open(name) as f:
                    # json.load —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ñ–∞–π–ª–æ–≤—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏ –Ω–∞–ø—Ä—è–º—É—é
                    entries = json.load(f)
                    
                    # –ì–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –≤—Å—Ç–∞–≤–∫–∏ (executemany)
                    to_insert = []
                    for entry in entries:
                        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–µ–∑—ã –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –≤ –∑–∞–ø–∏—Å–∏ –±–æ–ª—å—à–µ 6 —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                        word, reading, kind, _, priority, translation = entry[:6]
                        
                        # –°–æ–±–∏—Ä–∞–µ–º –∫–æ—Ä—Ç–µ–∂ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
                        # '; '.join(translation) - –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
                        to_insert.append(
                            (word, reading, kind, '; '.join(translation), int(priority))
                        )
                    
                    if to_insert:
                        # executemany - —Å–∞–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –≤—Å—Ç–∞–≤–∏—Ç—å –º–Ω–æ–≥–æ –∑–∞–ø–∏—Å–µ–π
                        cur.executemany(
                            'INSERT INTO translations VALUES (?, ?, ?, ?, ?)',
                            to_insert
                        )
                        total_entries_added += len(to_insert)

        # con.commit() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –û–î–ò–ù –†–ê–ó –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –í–°–ï–• —Ñ–∞–π–ª–æ–≤ –≤ –∞—Ä—Ö–∏–≤–µ.
        # –≠—Ç–æ –∫–ª—é—á –∫ –≤—ã—Å–æ–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
        con.commit()
        print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ {total_entries_added} –∑–∞–ø–∏—Å–µ–π –∏–∑ {zip_path.name}.")

    except (zipfile.BadZipFile, json.JSONDecodeError) as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞ {zip_path.name}: {e}", file=sys.stderr)
        # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ —Å —ç—Ç–∏–º –∞—Ä—Ö–∏–≤–æ–º
        con.rollback()
    except sqlite3.Error as e:
        print(f"–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –∏–∑ {zip_path.name}: {e}", file=sys.stderr)
        con.rollback()


def main():
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –ø–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–º.
    """
    parser = argparse.ArgumentParser(
        description="–ò–º–ø–æ—Ä—Ç–µ—Ä —Å–ª–æ–≤–∞—Ä–µ–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ JMDict (zip) –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö SQLite.",
        formatter_class=argparse.RawTextHelpFormatter # –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è help
    )
    parser.add_argument(
        "dictionary_files",
        metavar="ZIP_FILE",
        type=Path,
        nargs='+',  # '+' –æ–∑–Ω–∞—á–∞–µ—Ç "–æ–¥–∏–Ω –∏–ª–∏ –±–æ–ª—å—à–µ" –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
        help="–ü—É—Ç—å –∫ –æ–¥–Ω–æ–º—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º ZIP-–∞—Ä—Ö–∏–≤–∞–º —Å–ª–æ–≤–∞—Ä–µ–π –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞."
    )
    parser.add_argument(
        "-o", "--output",
        type=Path,
        default=Path("dict.db"), # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ñ–∞–π–ª —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        help="–ü—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: dict.db)."
    )
    parser.add_argument(
        "-f", "--force",
        action="store_true", # –ï—Å–ª–∏ —Ñ–ª–∞–≥ –µ—Å—Ç—å, —Ç–æ True, –∏–Ω–∞—á–µ False
        help="–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è."
    )

    args = parser.parse_args()
    db_path = args.output

    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª –ë–î –∏ –Ω–µ —É–∫–∞–∑–∞–Ω –ª–∏ —Ñ–ª–∞–≥ --force
    if db_path.exists() and not args.force:
        print(
            f"–§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö '{db_path}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–ª–∞–≥ -f –∏–ª–∏ --force, —á—Ç–æ–±—ã –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –µ–≥–æ.",
            file=sys.stderr
        )
        sys.exit(1)
    
    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    if db_path.exists():
        try:
            os.remove(db_path)
            print(f"–°—Ç–∞—Ä—ã–π —Ñ–∞–π–ª '{db_path}' —É–¥–∞–ª–µ–Ω.")
        except OSError as e:
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª '{db_path}': {e}", file=sys.stderr)
            sys.exit(1)

    # –°–æ–∑–¥–∞–µ–º –ë–î –∏ –ø–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    con = create_database(db_path)
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º 'with con:' –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –∏ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    try:
        with con:
            # –ò—Ç–µ—Ä–∏—Ä—É–µ–º—Å—è –ø–æ –≤—Å–µ–º —Ñ–∞–π–ª–∞–º —Å–ª–æ–≤–∞—Ä–µ–π, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º –≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
            for zip_file in args.dictionary_files:
                if not zip_file.is_file():
                    print(f"–í–Ω–∏–º–∞–Ω–∏–µ: —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫: {zip_file}", file=sys.stderr)
                    continue
                import_dictionary_from_zip(zip_file, con)
            
            print("–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞...")
            # –ò–Ω–¥–µ–∫—Å —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö - —ç—Ç–æ —Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–±
            con.cursor().execute('CREATE INDEX translations_index ON translations(word)')
            print("–ò–Ω–¥–µ–∫—Å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω.")

    except Exception as e:
        print(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}", file=sys.stderr)
        sys.exit(1)

    print("\nüéâ –í—Å–µ —Å–ª–æ–≤–∞—Ä–∏ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!")
    print(f"–ò—Ç–æ–≥–æ–≤–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤: {db_path.resolve()}")


if __name__ == "__main__":
    main()
